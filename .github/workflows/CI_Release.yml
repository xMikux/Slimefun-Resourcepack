name: CI_Release

on:
  push:
    tags:
      - "v*"

jobs:
  Create-Release:
    name: "ðŸ“¢ Create Release"
    runs-on: ubuntu-latest
    if: |
      github.repository == 'xMikux/Slimefun-Resourcepack'

    steps:
      - name: ðŸ“„ Checking Repostiory
        uses: actions/checkout@v3
        with:
          ref: pack
          fetch-depth: 0

      - name: âï¸ Bump Up Version
        env:
          TAG: ${{ github.ref }}
        run: |
          TAGNAME=${TAG:10}
          sed -i 's/Beta/Release/1' pack.mcmeta
          sed -i '4s+v[[:digit:]]*.[[:digit:]]*.[[:digit:]]*+'$TAGNAME'+1' pack.mcmeta

      - name: ðŸ“¥ Download Item models
        env:
          TAG: ${{ github.ref }}
        run: |
          TAGNAME=${TAG:10}
          curl https://raw.githubusercontent.com/xMikux/Slimefun-Resourcepack/$TAGNAME/Resourcepack/item-models.yml --output item-models.yml

      - name: ðŸ”§ Make Optimized Pack
        uses: ComunidadAylas/PackSquash-action@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          allow_optifine_mod: true
          never_store_squash_times: true
          path: ./

      - name: â˜ï¸ DownloadArtifact Optimized Pack
        uses: actions/download-artifact@v4
        with:
          name: Optimized pack
          path: ./

      - name: ðŸ“ Rename Optimized Pack
        run: |
          mv ./pack.zip Slimefun-ResourcePack.zip

      - name: ðŸ—‘ï¸ Delete Artifact
        uses: geekyeggo/delete-artifact@v2
        with:
          name: |
            Optimized pack

      - name: âœ… Make Checksum
        run: |
          SUM0=$(sha256sum Slimefun-ResourcePack.zip)
          SUM1=$(sha256sum item-models.yml)
          echo -e "$SUM0\n$SUM1" > checksums.txt

      - name: âœ¨ Create & Upload Releases 
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          files: |
            Slimefun-ResourcePack.zip
            item-models.yml
            checksums.txt
